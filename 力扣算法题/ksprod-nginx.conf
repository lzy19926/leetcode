server_tokens off;

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    location / {
        rewrite ^(.*)$  https://$http_host$1 redirect;
    }
}
server {
    listen 443;
    listen [::]:443;
   
    add_header X-Frame-Options SAMEORIGIN;
 
    # root /opt/zoomeyebe/web/build;
    root /opt/zoomeyebe/node_modules/zoomeyebe-ui/build;

    index index.html index.htm index.nginx-debian.html;

    server_name _;

    #https 配置
    ssl                  on;
    ssl_certificate      /opt/config/https-cert/server.crt;
    ssl_certificate_key  /opt/config/https-cert/server.key;
    ssl_session_timeout  5m;       
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;

    #ie跳转检测
    set $ieflag 0;
    if ($http_user_agent ~ 'Trident' ) {
        set $ieflag "${ieflag}1";
    }
    if ($uri !~ (^/oem|/ie.html|^/ie_logo)) {
        set $ieflag "${ieflag}1";
    } 
    if ($ieflag = '011') {
        rewrite ^(.*)$  https://$http_host/ie.html break;
    } 

    # 升级中检测
    set $updating 0;
    if (-e '/opt/config/updating.lock') {
        set $updating "${updating}1";
    }
    if ($uri !~ /updating) {
        set $updating "${updating}1";
    } 
    if ($uri !~ (^/oem|^/ie|^/api/ksp/upgrade|^/packages|^/api/system/getCert|.*.(gif|jpg|jpeg|png|bmp|swf|js|css)$)) {
        set $updating "${updating}1";
    } 
    if ($updating = '0111') {
        rewrite ^(.*)$  https://$http_host/updating.html break;
    } 
    # 不在升级中检测
    set $notupdating 0;
    if (!-e '/opt/config/updating.lock') {
        set $notupdating "${notupdating}1";
    }
    if ($uri ~ /updating) {
        set $notupdating "${notupdating}1";
    } 
    if ($notupdating = '011') {
        rewrite ^(.*)$  https://$http_host break;
    } 

    location / {
        add_header X-Frame-Options SAMEORIGIN;
        add_header Cache-Control no-store;
        try_files $uri /index.html;
    }

    location /api {
        proxy_pass http://127.0.0.1:8933/api;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        client_max_body_size 256m;
        add_header Cache-Control no-store;
        proxy_read_timeout 150s;
    } 

    location /api/geoInfo {
        proxy_pass http://127.0.0.1:13133/api/geoInfo;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        client_max_body_size 100m;
        add_header Cache-Control no-store;
        proxy_read_timeout 150s;
    }

    location /api/receive {
        proxy_pass http://127.0.0.1:13131/api/receive;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        client_max_body_size 100m;
        add_header Cache-Control no-store;
        proxy_read_timeout 150s;
    }

    location /api/system/uploadMaxPackage {
        proxy_pass http://127.0.0.1:8933/api/system/uploadMaxPackage;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        client_max_body_size 0;
        add_header Cache-Control no-store;
        proxy_read_timeout 3600s;
    }

    location /api/system/uploadPackage {
        proxy_pass http://127.0.0.1:8933/api/system/uploadPackage;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        client_max_body_size 0;
        add_header Cache-Control no-store;
        proxy_read_timeout 3600s;
    }

    location /api/ksp/upgrade {
        limit_except GET {  
            deny  all;  
        }  
        proxy_pass http://127.0.0.1:10080/api/v1/ksp/pkg;
        add_header Cache-Control no-store;
    } 
    
    location /socket.io {
        proxy_pass http://127.0.0.1:13020/socket.io;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header Cache-Control no-store;

        # ws
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    } 

    location ~ ^/oem {
        root /opt/zoomeyebe;
    }

    location /ie.html {
        proxy_pass http://127.0.0.1:8933/api/system/ie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        add_header Cache-Control no-store;
    }

    location /packages {
        root /opt/config/server;
        autoindex off; 
    }

    #图片缓存10天
    location ~ .*.(gif|jpg|jpeg|png|bmp|swf)$
    {
        expires 10d;
    }

    #JS和CSS缓存1天
    location ~ .*.(js|css)$
    {
        expires 1d;
    }

    # oem定制nginx配置, 需要保持该文件存在
    include "/opt/config/oem-nginx.conf";
}
